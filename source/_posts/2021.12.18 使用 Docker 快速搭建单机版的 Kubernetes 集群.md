---
title: 'ä½¿ç”¨ Docker å¿«é€Ÿæ­å»ºå•æœºç‰ˆçš„ Kubernetes é›†ç¾¤'
cover: 'https://s2.loli.net/2021/12/18/cAPfsvQCEGg8HKi.jpg'
subtitle: 'å¿«é€Ÿæ­å»ºç”¨äºå¼€å‘/å­¦ä¹ ï¼Œæ›´è´´è¿‘çœŸå®çš„ K8s ç¯å¢ƒ'
tags:
  - k8s
  - kubernetes
  - kind
  - minikube
  - microk8s
author:
  nick: æ¨æ–Œ
  link: https://github.com/y0ngb1n
abbrlink: 'running-local-Kubernetes-clusters-using-docker'
date: 2021-12-18 20:33:00
---
éšç€å®¹å™¨åŒ–ã€å¾®æœåŠ¡ã€æœåŠ¡ç½‘æ ¼ã€æœåŠ¡ç¼–æ’ã€DevOps ç­‰äº‘åŸç”ŸæŠ€æœ¯çš„æµè¡Œï¼Œæˆ‘ä»¬ä¹Ÿè¦è·Ÿä¸Šæ—¶ä»£çš„æ­¥ä¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ€ä¹ˆä¸Šè½¦å‘¢ï¼Ÿæ­¤æ—¶å°±éœ€è¦ä¸€ä¸ªæ˜“äºåœ¨æœ¬åœ°è¿è¡Œä¸” Kubernetes çš„å·¥å…·ï¼Œå¯åœ¨ä½ çš„ç¬”è®°æœ¬ç”µè„‘ä¸Šçš„è™šæ‹Ÿæœºå†…è½»æ¾åˆ›å»ºå•æœºç‰ˆ Kubernetes é›†ç¾¤ï¼Œä¾¿äºæˆ‘ä»¬ä½¿ç”¨ Kubernetes è¿›è¡Œæ—¥å¸¸å¼€å‘ä¸å­¦ä¹ ã€‚é‚£ä¹ˆæ¥ä¸‹è®©æˆ‘ä»¬è½»æ¾åœ°æ­å»ºä¸€ä¸ªæ›´è´´è¿‘çœŸå®çš„ K8s ç¯å¢ƒã€‚

## å·¥å…·æ¨è

å¯¹äºæœ¬åœ°å®éªŒï¼Œè¿˜å¯ä»¥ä½¿ç”¨å„ç§ Kubernetes å®ç°ä»¥è¿è¡Œ Kubernetes ç¾¤é›†ï¼Œå¦‚

- Kind ([https://kind.sigs.k8s.io/](https://kind.sigs.k8s.io/))
- Minikube ([https://minikube.sigs.k8s.io/docs/](https://minikube.sigs.k8s.io/docs/))
- MicroK8s ([https://microk8s.io/](https://microk8s.io/))
- åœ¨çº¿ä½“éªŒÂ K8s ([https://labs.play-with-k8s.com/](https://labs.play-with-k8s.com/))
- Dockerized ([https://github.com/y0ngb1n/dockerized](https://github.com/y0ngb1n/dockerized)) æ¨èæˆ‘çš„ä¸ªäººé¡¹ç›®ï¼Œæ¬¢è¿ Star

ä½¿ç”¨ä¸Šé¢ä»»ä¸€å·¥å…·çš„ç›®æ ‡éƒ½èƒ½å¿«é€Ÿè¿è¡Œä¸€ä¸ªæœ¬åœ°å­¦ä¹ çš„ Kubernetes ç¾¤é›†ï¼Œå…¶ä¸­æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„æ˜¯ Kindã€‚

## æ­å»º K8s é›†ç¾¤

ä¸‹é¢åˆ†åˆ«å°è¯• Kind ä¸ Minikube åˆ›å»ºå•æœºç‰ˆ Kubernetes é›†ç¾¤ã€‚

### å…ˆå®‰è£… `kubectl`

æ— è®ºä½¿ç”¨å“ªä¸ªå·¥å…·ï¼Œéƒ½éœ€è¦å…ˆæ­£ç¡®å®‰è£… `kubectl` Kubernetes å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦åˆ™å®‰è£…å®Œ Kindã€Minikube ç­‰ç¯å¢ƒåæ— æ³•æ‰§è¡Œ `kubectl` å‘½ä»¤ã€‚

- å®‰è£…æ–‡æ¡£ï¼šhttps://kubernetes.io/zh/docs/tasks/tools/#kubectl

### ä½¿ç”¨ Kind åˆ›å»º K8s é›†ç¾¤

> kind is a tool for running local Kubernetes clusters using Docker container â€œnodesâ€.

#### å®‰è£… `kind`

[Kind](https://kind.sigs.k8s.io/docs/user/quick-start/) æä¾›äº†å¤šç§å®‰è£…æ–¹å¼ï¼Œæ”¯æŒä»¥ä¸‹æ–¹å¼ï¼š

- On macOS via Homebrew
- On macOS via MacPorts
- On Windows via Chocolatey
- [Installing From Release Binaries](https://github.com/kubernetes-sigs/kind/releases)
- Installing From Source

è¿™é‡Œå°†åœ¨ Linux ç¯å¢ƒä¸‹ä»¥ Installing From Release Binaries æ–¹å¼è¿›è¡Œå®‰è£…ï¼š

```bash
curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-linux-amd64
chmod +x ./kind
# mv ./kind /some-dir-in-your-PATH/kind
```

#### åˆ›å»º K8s é›†ç¾¤

```bash
kind create cluster
# kind delete cluster
```

#### æ£€éªŒå®‰è£…ç¯å¢ƒ
    
```bash
ğŸ‹ï¸ ~ kind get clusters
kind
```

### ä½¿ç”¨ Minikube åˆ›å»º K8s é›†ç¾¤

#### å®‰è£… `minikube`

é€‰æ‹©ä¸åŒç¯å¢ƒä¸‹çš„å®‰è£…æ–¹å¼ï¼Œå‚è€ƒ [https://minikube.sigs.k8s.io/docs/start/](https://minikube.sigs.k8s.io/docs/start/)

```bash
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
```

å›½å†…ç½‘ç»œç¯å¢ƒï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å°†è‡ªåŠ¨ä½¿ç”¨é˜¿é‡Œäº‘æœåŠ¡æ¥æ”¯æŒ `minikube` çš„ç¯å¢ƒé…ç½®ï¼Œå‚è€ƒ [https://developer.aliyun.com/article/221687](https://developer.aliyun.com/article/221687)

```bash
minikube start --image-mirror-country='cn'
# minikube delete
```

#### æ£€éªŒå®‰è£…ç¯å¢ƒ
    
```bash
ğŸ‹ï¸ ~ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
```

å¯åŠ¨ K8s æ§åˆ¶å°ï¼Œå‚è€ƒ [https://minikube.sigs.k8s.io/docs/handbook/dashboard/](https://minikube.sigs.k8s.io/docs/handbook/dashboard/)
    
```bash
minikube dashboard
# or
minikube dashboard --url
```
    
æŸ¥çœ‹ `minikube` æ”¯æŒçš„æ‰©å±•åˆ—è¡¨ï¼Œå‚è€ƒ [https://minikube.sigs.k8s.io/docs/handbook/deploying/](https://minikube.sigs.k8s.io/docs/handbook/deploying/)
    
```bash
minikube addons list
```

## æ£€éªŒ K8s é›†ç¾¤

```bash
ğŸ‹ï¸ ~ kubectl version
Client Version: version.Info{Major:"1", Minor:"21", GitVersion:"v1.21.1", GitCommit:"5e58841cce77d4bc13713ad2b91fa0d961e69192", GitTreeState:"clean", BuildDate:"2021-05-12T14:18:45Z", GoVersion:"go1.16.4", Compiler:"gc", Platform:"linux/amd64"}
Server Version: version.Info{Major:"1", Minor:"22", GitVersion:"v1.22.3", GitCommit:"c92036820499fedefec0f847e2054d824aea6cd1", GitTreeState:"clean", BuildDate:"2021-10-27T18:35:25Z", GoVersion:"go1.16.9", Compiler:"gc", Platform:"linux/amd64"}

# æŸ¥çœ‹å½“å‰æŒ‡å‘çš„ k8s ç¯å¢ƒï¼Œkind/minikube å®‰è£…æ—¶ä¼šè‡ªåŠ¨ä¿®æ”¹ kubectl é…ç½®
ğŸ‹ï¸ ~ kubectl config current-context
kind-kind

# å¦‚æœ¬åœ°æœ‰å¤šä¸ª k8s ç¯å¢ƒï¼Œå¯æ‰‹åŠ¨åˆ‡æ¢
ğŸ‹ï¸ ~ kubectl config use-context minikube
Switched to context "minikube".

# æ£€æŸ¥æœåŠ¡å™¨èŠ‚ç‚¹
ğŸ‹ï¸ ~ kubectl get no
NAME       STATUS   ROLES                  AGE   VERSION
minikube   Ready    control-plane,master   36m   v1.22.3

ğŸ‹ï¸ ~ kubectl get nodes -o wide
NAME       STATUS   ROLES                  AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
minikube   Ready    control-plane,master   15m   v1.22.3   192.168.49.2   <none>        Ubuntu 20.04.2 LTS   5.4.0-42-generic   docker://20.10.8

# æŸ¥çœ‹ k8s é›†ç¾¤ä¿¡æ¯
ğŸ‹ï¸ ~ kubectl cluster-info
Kubernetes control plane is running at https://192.168.49.2:8443
CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

## K8s åˆä½“éªŒ

### å¿«é€Ÿå°é²œ

```bash
# å¯åŠ¨å•å®ä¾‹ nginx
ğŸ‹ï¸ ~ kubectl create deployment nginx-depl --image=nginx

# æŸ¥çœ‹è¿è¡Œçš„å®ä¾‹
ğŸ‹ï¸ ~ kubectl get pod
NAME                          READY   STATUS    RESTARTS   AGE
nginx-depl-5c8bf76b5b-zw8ms   1/1     Running   0          70s

# è½¬å‘ä¸€ä¸ªæœ¬åœ° 8080 ç«¯å£åˆ° Pod 80 ç«¯å£
ğŸ‹ï¸ ~ kubectl port-forward nginx-depl-5c8bf76b5b-zw8ms 8080:80

# æœ¬åœ°è®¿é—®
ğŸ‹ï¸ ~ curl 127.0.0.1:8080

# æ¸…é™¤å®ä¾‹
ğŸ‹ï¸ ~ kubectl delete deployment nginx-depl
```

### å°è¯•ç‰›åˆ€

`nginx-pod.yml`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  containers:
    - name: nginx
      image: nginx
```

`nginx-svc.yml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: 31080
  selector:
    app: nginx
  type: NodePort
```

æ‰§è¡Œå‘½ä»¤ï¼š

```bash
# ä¸€é”®å‘å¸ƒï¼Œå¯åŠ¨å®ä¾‹
ğŸ‹ï¸ ~ kubectl apply -f .

# è°ƒè¯• Pod
ğŸ‹ï¸ ~ kubectl describe pod nginx
ğŸ‹ï¸ ~ kubectl port-forward nginx 8080:80

# è°ƒè¯• Service
ğŸ‹ï¸ ~ kubectl describe svc nginx-svc
ğŸ‹ï¸ ~ kubectl port-forward service/nginx-svc 8080:80

# æ¸…é™¤å®ä¾‹
ğŸ‹ï¸ ~ kubectl delete -f .
```

## æ³¨æ„äº‹é¡¹

- éœ€è¦å…ˆæ­£ç¡®å®‰è£… `kubectl`
- é€šè¿‡ Port-Forward å¯æœ¬æœºè®¿é—® Podï¼Œä»…é™æœ¬åœ°è°ƒè¯•ç¯å¢ƒï¼Œå¦‚ `curl 127.0.0.1:8080`
- é€šè¿‡ Service åå‘ä»£ç†æ—¶ï¼Œéœ€è¦ä½¿ç”¨ K8s é›†ç¾¤çš„ IP è¿›è¡Œè®¿é—®ï¼Œä½¿ç”¨ `kubectl get nodes -o wide` æŸ¥çœ‹ K8s é›†ç¾¤çš„ IP
- Service æ˜¯ K8s æä¾›åå‘ä»£ç†çš„æœºåˆ¶ï¼Œè´Ÿè´£åå‘è·¯ç”±+è´Ÿè½½å‡è¡¡
- NodePort æ˜¯ Service çš„ä¸€ç§ç±»å‹ï¼Œå¯å°† Service æš´éœ²ç»™å¤–ç½‘
- NodePort èŒƒå›´ `30000~32767`
- Label æ˜¯ K8s çš„ç§æ‰“æ ‡ç­¾æœºåˆ¶
- Selector æ˜¯ K8s ä¸­çš„è·¯ç”±é€‰æ‹©å®šä½æœºåˆ¶
- ä½¿ç”¨ Kind æˆ– Minikube éƒ¨ç½²çš„ K8s é›†ç¾¤ï¼Œnode åŸºäºå®¹å™¨è¿è¡Œè€Œä¸æ˜¯å®¿ä¸»æœºï¼Œä½¿ç”¨ Service åå‘ä»£ç†æ—¶ï¼Œåªåœ¨ node èŠ‚ç‚¹å®¹å™¨ä¸­ kube-proxy ç”Ÿæ•ˆï¼Œä½¿ç”¨ `docker exec -it kind-control-plane bash` éªŒè¯è¿™ä¸€ç‚¹ï¼Œè€Œä¸æ˜¯ç›´æ¥æ˜ å°„åœ¨å®¿ä¸»æœºä¸Š

## K8sÂ æ•…éšœæ’æŸ¥æŒ‡å—

![a-visual-guide-on-troubleshooting-kubernetes-deployments](https://learnk8s.io/a/a-visual-guide-on-troubleshooting-kubernetes-deployments/troubleshooting-kubernetes.zh_cn.v2.png)

## å‚è€ƒé“¾æ¥

- https://kubernetes.io/zh/docs/tasks/tools/
- https://kind.sigs.k8s.io/docs/user/quick-start/
- https://developer.aliyun.com/article/221687
- https://learnk8s.io/troubleshooting-deployments
- https://b23.tv/2yDbtP9
- https://youtube.com/playlist?list=PLy7NrYWoggjziYQIDorlXjTvvwweTYoNC
